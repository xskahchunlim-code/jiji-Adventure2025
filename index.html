<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Jiji èŒåœºå¤§å†’é™© (æ’åç‰ˆ)</title>
    <style>
        body { 
            margin: 0; overflow: hidden; background-color: #f0f2f5; 
            font-family: 'å¾®è½¯é›…é»‘', sans-serif; 
            user-select: none;
        }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; align-items: center;
        }

        .hud-bar {
            display: flex; gap: 20px; margin-top: 20px;
            background: rgba(0,0,0,0.7); padding: 10px 30px; border-radius: 50px;
            color: white; font-size: 20px; font-weight: bold; pointer-events: auto;
            backdrop-filter: blur(5px); z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #ui-calendar { color: #ffce00; min-width: 140px; text-align: center; }

        .btn-group { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; pointer-events: auto; }
        .icon-btn {
            background: rgba(255, 255, 255, 0.2); border: 2px solid white;
            color: white; width: 45px; height: 45px; border-radius: 50%;
            cursor: pointer; font-weight: bold; font-size: 20px;
            transition: 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: white; color: #333; transform: scale(1.1); }

        #pause-overlay, #ranking-modal {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 200; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        .btn-resume {
            margin-top: 20px; padding: 15px 50px; font-size: 24px; 
            background: #00b894; color: white; border: none; border-radius: 50px; 
            cursor: pointer; font-weight: bold; box-shadow: 0 5px 0 #00856a;
        }

        /* çš®è‚¤è®¾ç½®å¼¹çª— */
        #settings-modal {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 25px; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); pointer-events: auto;
            width: 400px; text-align: center; z-index: 200;
            max-height: 80vh; overflow-y: auto;
        }
        .upload-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .upload-btn { background: #6c5ce7; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .close-btn { background: #aaa; color: white; border: none; padding: 10px 30px; border-radius: 50px; cursor: pointer; margin-top: 10px; }

        /* æ’è¡Œæ¦œæ ·å¼ */
        .modal-box {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); color: #333;
            max-width: 550px; width: 90%; text-align: center;
            position: relative; animation: popIn 0.3s ease-out;
            max-height: 85vh; overflow-y: auto;
        }
        .ranking-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 18px; color: #333; }
        .rank-num { font-weight: bold; color: #6c5ce7; width: 30px; }
        .rank-name { flex-grow: 1; text-align: left; margin-left: 10px; font-weight: bold; }
        .rank-score { color: #ffce00; font-weight: 900; text-shadow: 1px 1px 0 #999;}
        .input-group { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }
        #player-name-inp { padding: 10px; border-radius: 10px; border: 2px solid #ddd; font-size: 16px; width: 150px; }

        /* é—®ç­” & Sport Club å¼¹çª— */
        #quiz-modal {
            display: none; pointer-events: auto;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; width: 450px; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 5px solid #6c5ce7;
            text-align: center; z-index: 200;
        }
        .quiz-header { font-size: 24px; margin: 0 0 15px 0; font-weight: 900; }
        .quiz-btn {
            display: block; width: 100%; padding: 15px; margin: 10px 0;
            background: #f0f0f0; border: none; border-radius: 10px;
            font-size: 18px; cursor: pointer; transition: 0.2s;
        }
        .quiz-btn:hover { background: #6c5ce7; color: white; }

        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 100;
        }
        .btn-start {
            padding: 15px 40px; font-size: 24px; background: #ffce00; border: none;
            border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 0 #b38f00; transition: 0.1s; margin: 5px;
        }
        .btn-start:hover { transform: scale(1.05); }

        #preview-jiji {
            width: 150px; height: 150px; object-fit: contain; margin: 20px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
            animation: bounce 2s infinite ease-in-out;
        }
        @keyframes bounce { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

        .final-score { font-size: 80px; font-weight: 900; color: #ffce00; margin: 10px 0; text-shadow: 4px 4px 0 #000; }
        .final-comment { font-size: 24px; color: white; margin-bottom: 20px; font-weight: bold; max-width: 600px; text-align: center; line-height: 1.5; }
        
        #center-msg {
            position: absolute; top: 30%; width: 100%; text-align: center; 
            font-size: 80px; font-weight: 900; color: #ffce00; 
            text-shadow: 4px 4px 10px rgba(0,0,0,0.5); display: none; z-index: 20;
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div class="hud-bar">
            <span id="ui-calendar">ğŸ“… 1æœˆ 1æ—¥</span>
            <span id="ui-hearts">â¤ï¸â¤ï¸â¤ï¸</span>
            <span id="ui-score">KPI: 0</span>
            <span id="ui-iso">ISO: 0/5</span>
        </div>
        
        <div class="btn-group">
            <button class="icon-btn" onclick="togglePause()" title="æš‚åœ">â¸ï¸</button>
            <button class="icon-btn" onclick="openSettings()" title="æ¢çš®è‚¤">âš™ï¸</button>
            <button class="icon-btn" onclick="showRanking()" title="æ’è¡Œæ¦œ">ğŸ†</button>
        </div>

        <div id="center-msg"></div>
    </div>

    <div id="pause-overlay">
        <div style="color:white; font-size:60px; font-weight:900;">PAUSED</div>
        <button class="btn-resume" onclick="togglePause()">ç»§ç»­æ¬ç –</button>
        <button class="btn-resume" style="background:#ff7675; margin-left:10px;" onclick="location.reload()">é€€å‡ºæ¸¸æˆ</button>
    </div>

    <div id="ranking-modal">
        <div class="modal-box">
            <h2 style="color: #6c5ce7;">ğŸ† å…¨çƒæ’è¡Œæ¦œ</h2>
            <div id="ranking-list" style="min-height: 200px; max-height: 300px; overflow-y: auto;">
                <div style="color:#999; margin-top: 50px;">æ­£åœ¨è¿æ¥äº‘ç«¯...</div>
            </div>
            <button class="close-btn" onclick="document.getElementById('ranking-modal').style.display='none'">å…³é—­</button>
        </div>
    </div>

    <div id="settings-modal">
        <h2 style="margin-top: 0;">ğŸ¨ çš®è‚¤è®¾ç½® (æœ¬åœ°)</h2>
        <div class="upload-row"><span>ä¸»è§’ (Jiji)</span><input type="file" id="inp-jiji" hidden accept="image/*" onchange="handleUpload('jiji',this)"><button class="upload-btn" onclick="document.getElementById('inp-jiji').click()">ä¸Šä¼ </button></div>
        <div class="upload-row"><span>å¥¶èŒ¶ (å›è¡€)</span><input type="file" id="inp-tea" hidden accept="image/*" onchange="handleUpload('tea',this)"><button class="upload-btn" onclick="document.getElementById('inp-tea').click()">ä¸Šä¼ </button></div>
        <div class="upload-row"><span>åŠ åˆ† (Bug)</span><input type="file" id="inp-bug" hidden accept="image/*" onchange="handleUpload('bug',this)"><button class="upload-btn" onclick="document.getElementById('inp-bug').click()">ä¸Šä¼ </button></div>
        <button class="close-btn" onclick="closeSettings()">ä¿å­˜å¹¶å…³é—­</button>
    </div>

    <div id="quiz-modal">
        <h3 id="quiz-title" class="quiz-header" style="color:#6c5ce7;">ğŸ”¥ èŒåœºé€å‘½é¢˜</h3>
        <div id="quiz-question" style="font-size: 22px; margin-bottom: 25px; font-weight: bold; color: #333;"></div>
        <div id="quiz-options"></div>
    </div>

    <div id="overlay">
        <h1 id="game-title" style="color:white; font-size: 50px; margin-bottom: 0px; text-shadow: 4px 4px 0 #333;">Jiji èŒåœºå¤§å†’é™©</h1>
        <div style="color:#ffce00; font-size:20px; font-weight:bold; margin-bottom:10px;">~ å¹´åº¦è€ƒæ ¸ç‰ˆ ~</div>
        
        <img id="preview-jiji" src="" alt="Jiji Preview">
        
        <div id="game-over-ui" style="display: none; flex-direction: column; align-items: center;">
            <div style="color: #ddd; font-size: 20px;">å¹´åº¦æ€» KPI</div>
            <div class="final-score" id="final-score-display">0</div>
            <div class="final-comment" id="final-comment-display"></div>
            <div class="input-group">
                <input type="text" id="player-name-inp" placeholder="è¾“å…¥å¤§å" maxlength="10">
                <button class="btn-start" style="padding: 10px 20px; font-size: 16px;" onclick="submitScore()">ä¸Šä¼ æˆç»©</button>
            </div>
        </div>

        <div id="start-ui">
            <p style="color:#eee; font-size: 18px; margin-bottom: 30px; text-align: center;">
                <b>ç›®æ ‡ï¼šæ’‘è¿‡ 12 ä¸ªæœˆï¼</b><br>
                æ¯ä¸ªæœˆéƒ½æœ‰ Sport Club çªå‡»æ£€æŸ¥<br>
                æŒ‰ <b>â† â†’</b> ç§»åŠ¨ | èº²é¿ç”µè„‘ | å–å¥¶èŒ¶å›è¡€
            </p>
        </div>
        <button class="btn-start" onclick="initGame()">å¼€å§‹å¥‹æ–—</button>
        <button class="btn-start" style="background:white; color:#333; font-size:18px; padding:10px 30px;" onclick="showRanking()">æŸ¥çœ‹æ’è¡Œ</button>
    </div>

    <audio id="bgm" loop src="bgm.mp3"></audio>
    <audio id="sfx-jump" src="jump.mp3"></audio>
    <audio id="sfx-coin" src="coin.mp3"></audio>
    <audio id="sfx-hit" src="hit.mp3"></audio>
    <audio id="sfx-win" src="win.mp3"></audio>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>

    <script type="module">
        import * as THREE from 'three';
        // å¼•å…¥ Firebase SDK (ä½¿ç”¨ CDN æ–¹å¼ï¼Œé€‚åˆçº¯ HTML æ–‡ä»¶)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =========================================================
        // âœ… ä½ çš„ Firebase Config å·²å¡«å…¥ï¼
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBd2xW-b9WNy8JmlSNdjsVEswzZHkr3-Hs",
            authDomain: "jiji-adventure.firebaseapp.com",
            projectId: "jiji-adventure",
            storageBucket: "jiji-adventure.firebasestorage.app",
            messagingSenderId: "215317927346",
            appId: "1:215317927346:web:e71d19eeacc1271b1f00ab",
            measurementId: "G-ZSPSHTN01L"
        };

        let db;
        let isFirebaseReady = false;

        try {
            if(firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isFirebaseReady = true;
                console.log("Firebase Connected");
            }
        } catch(e) { console.error("Firebase Config Error:", e); }

        // === 1. æè´¨ç®¡ç† ===
        function mkTex(t) {
            const c=document.createElement('canvas');c.width=256;c.height=256;const x=c.getContext('2d');x.clearRect(0,0,256,256);
            if(t=='jiji'){
                x.fillStyle='white';x.beginPath();x.arc(128,140,100,0,7);x.fill();x.lineWidth=5;x.stroke();
                x.fillStyle='red';x.beginPath();x.arc(128,40,30,0,7);x.fill();
                x.fillStyle='black';x.fillText("QA",90,180);x.beginPath();x.arc(90,120,10,0,7);x.arc(166,120,10,0,7);x.fill();
            } else if(t=='tea'){ x.fillStyle='#ffb6c1';x.fillRect(80,60,96,140); } 
            else if(t=='bug'){ x.fillStyle='gold';x.beginPath();x.arc(128,128,100,0,7);x.fill();x.fillStyle='black';x.font='100px Arial';x.fillText("$",100,160); } 
            else if(t=='computer'){ x.fillStyle='#ff5555';x.fillRect(28,28,200,200);x.fillStyle='white';x.font='80px Arial';x.fillText("BUG",45,150); } 
            else if(t=='fish'){ x.fillStyle='#00bfff';x.beginPath();x.ellipse(128,128,100,60,0,0,7);x.fill(); } 
            else if(t=='iso'){ x.fillStyle='#00ffff';x.fillRect(40,40,176,176);x.lineWidth=8;x.strokeStyle='#008b8b';x.strokeRect(40,40,176,176); } 
            else if(t=='quiz'){ x.fillStyle='#6c5ce7';x.fillRect(28,28,200,200);x.fillStyle='white';x.font='120px Arial';x.fillText("?",95,170); }
            return c.toDataURL();
        }

        function loadMat(key) {
            // é€»è¾‘: 1. æœ¬åœ°ä¸Šä¼ è¿‡? -> 2. æ–‡ä»¶å¤¹é‡Œæœ‰æ–‡ä»¶(github)? -> 3. ç”»ä¸€ä¸ª
            const saved = localStorage.getItem('jiji_skin_' + key);
            if (saved) {
                const img = new Image(); img.src = saved;
                const tex = new THREE.Texture(img); img.onload = () => { tex.needsUpdate = true; if(key=='jiji') updatePreview(saved); };
                return new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide });
            } else {
                // å°è¯•ä»æ–‡ä»¶å¤¹åŠ è½½ (é€‚åº” GitHub)
                const tex = new THREE.TextureLoader().load(key + '.png', 
                    (t) => { t.colorSpace = THREE.SRGBColorSpace; if(key=='jiji') updatePreview(key+'.png'); },
                    undefined,
                    () => { /* å¤±è´¥åˆ™ç”¨å ä½ç¬¦ */ }
                );
                return new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide });
            }
        }
        
        function updatePreview(src) { document.getElementById('preview-jiji').src = src; }

        const mats = {
            jiji: loadMat('jiji'), bug: loadMat('bug'), computer: loadMat('computer'),
            fish: loadMat('fish'), iso: loadMat('iso'), quiz: loadMat('quiz'), tea: loadMat('tea')
        };
        
        // åˆå§‹é¢„è§ˆ
        const initSaved = localStorage.getItem('jiji_skin_jiji');
        if(initSaved) updatePreview(initSaved);

        // === è®¾ç½®ä¸ä¸Šä¼  ===
        window.handleUpload = (key, input) => {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                try {
                    localStorage.setItem('jiji_skin_' + key, base64);
                    // åˆ·æ–°æè´¨
                    const img = new Image(); img.src = base64;
                    img.onload = () => { 
                        mats[key].map.image = img; mats[key].map.needsUpdate = true; 
                        if(key=='jiji') updatePreview(base64);
                        alert("çš®è‚¤æ›´æ–°æˆåŠŸï¼"); 
                    };
                } catch (err) { alert("å›¾ç‰‡å¤ªå¤§ï¼Œè¯·å‹ç¼©åé‡è¯•ã€‚"); }
            };
            reader.readAsDataURL(file);
        };
        window.openSettings = () => { document.getElementById('settings-modal').style.display = 'block'; window.togglePause(true); };
        window.closeSettings = () => { document.getElementById('settings-modal').style.display = 'none'; };

        // === 2. åœºæ™¯ ===
        const scene=new THREE.Scene(); scene.background=new THREE.Color(0xdceefb); scene.fog=new THREE.Fog(0xdceefb,10,60);
        const camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,1000); camera.position.set(0,5,8); camera.lookAt(0,0,-5);
        const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth,window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff,0.7)); 
        const dl=new THREE.DirectionalLight(0xffffff,0.8); dl.position.set(5,10,5); scene.add(dl);
        const ground=new THREE.Mesh(new THREE.PlaneGeometry(100,1000), new THREE.MeshPhongMaterial({color:0x34495e})); ground.rotation.x=-Math.PI/2; ground.position.z=-450; scene.add(ground);
        const grid=new THREE.GridHelper(200,100,0x555555,0x444444); grid.position.y=0.01; grid.position.z=-50; scene.add(grid);
        const wG=new THREE.PlaneGeometry(20,1000); const wM=new THREE.MeshBasicMaterial({color:0xbdc3c7});
        const w1=new THREE.Mesh(wG,wM); w1.rotation.y=Math.PI/2; w1.position.set(-6,5,-450); scene.add(w1);
        const w2=new THREE.Mesh(wG,wM); w2.rotation.y=-Math.PI/2; w2.position.set(6,5,-450); scene.add(w2);

        // === 3. æ¸¸æˆæ•°æ®ä¸é€»è¾‘ (ä¿æŒåŸç‰ˆä¸‰é€‰ä¸€) ===
        const questions = [
            {q:"äº”å½©æ–‘æ–“çš„é»‘ï¼Ÿ", o:["æ‰“ä»–","è°ƒæ•´å¯¹æ¯”åº¦","ç­”åº”ä½†ä¸æ”¹"], a:2},
            {q:"å‘¨äº” 5:55 PM å´©äº†", o:["å‡è£…æ²¡çœ‹è§","ç«‹é©¬ä¿®å¤","å‘æœ‹å‹åœˆ"], a:1},
            {q:"è€æ¿è¯´'å¾ˆç®€å•'", o:["çœŸçš„ç®€å•","ä¸ç»™é’±è¿˜è¦å¿«","ä»–æƒ³è‡ªå·±åš"], a:1},
            {q:"ä»£ç å‡º Bug ç¬¬ä¸€ååº”ï¼Ÿ", o:["æ˜¯ Feature","æˆ‘ç”µè„‘æ²¡é—®é¢˜","æ€ªå®ä¹ ç”Ÿ"], a:0},
            {q:"åŒäº‹ç”©é”…ç»™ä½ ï¼Ÿ", o:["å¿æ°”åå£°","æˆªå›¾å›æ€¼","é€€ç¾¤"], a:1},
            {q:"KPI æ˜¯ä»€ä¹ˆï¼Ÿ", o:["Kill People","Key Performance","Keep Playing"], a:1},
            {q:"å±å±±ä»£ç ï¼Ÿ", o:["é‡æ„","ç¦»èŒ","èƒ½è·‘åˆ«åŠ¨"], a:2},
            {q:"è€æ¿è®²å†·ç¬‘è¯ï¼Ÿ", o:["é¢æ— è¡¨æƒ…","å°´å°¬ç¬‘","å¤§ç¬‘é¼“æŒ"], a:2},
            {q:"éœ€æ±‚å˜äº†ç¬¬10æ¬¡", o:["åˆ€åœ¨æ‰‹","ç¬‘è„¸ç›¸è¿","åŠ é’±å¥½è¯´"], a:2},
            {q:"å›¢å»ºå»å“ªé‡Œï¼Ÿ", o:["å ç”¨å‘¨æœ«çˆ¬å±±","å·¥ä½œæ—¥èšé¤","å‘é’±è§£æ•£"], a:2}
        ];

        let gameState='IDLE', score=0, health=3, isoCount=0, frame=0, lane=1, jijiMesh;
        let gameSpeed = 0.18; let isPaused = false;
        
        const CLOCK = new THREE.Clock();
        const SECONDS_PER_MONTH = 15; 
        let currentMonth = 1; let monthTimer = 0;
        
        const obstacles=[], lanes=[-2.5,0,2.5]; 

        window.initGame = () => {
            // æ’­æ”¾å£°éŸ³
            playSound('bgm'); 

            document.getElementById('overlay').style.display='none';
            document.getElementById('game-over-ui').style.display='none';
            document.getElementById('start-ui').style.display='block';
            document.getElementById('preview-jiji').style.display='none';
            document.querySelector('#game-title').innerText="Jiji èŒåœºå¤§å†’é™©";
            
            score=0; health=3; isoCount=0; gameSpeed = 0.18;
            currentMonth = 1; monthTimer = 0;
            CLOCK.start();

            obstacles.forEach(o=>scene.remove(o)); obstacles.length=0;
            updateHUD();

            if(jijiMesh) scene.remove(jijiMesh);
            jijiMesh = new THREE.Mesh(new THREE.PlaneGeometry(2.5,2.5), mats.jiji); 
            jijiMesh.position.set(0,1,0); jijiMesh.castShadow=true; scene.add(jijiMesh);
            lane=1;

            startCountdown();
        };

        function startCountdown() {
            gameState = 'COUNTDOWN';
            let count = 3;
            const msg = document.getElementById('center-msg');
            msg.style.display = 'block'; msg.innerText = count;
            
            animate(); 
            let timer = setInterval(() => {
                count--;
                if(count>0) { msg.innerText = count; playSound('sfx-jump'); }
                else {
                    clearInterval(timer);
                    msg.innerText = "GO!";
                    playSound('sfx-coin');
                    setTimeout(()=>{ msg.style.display='none'; gameState='PLAYING'; CLOCK.getDelta(); }, 500);
                }
            }, 1000);
        }

        window.togglePause = (forcePause = false) => {
            if (gameState !== 'PLAYING' && gameState !== 'PAUSED') return;
            if (forcePause || !isPaused) { 
                isPaused = true; gameState = 'PAUSED'; 
                document.getElementById('pause-overlay').style.display = 'flex'; 
                CLOCK.stop(); 
            } else {
                isPaused = false; gameState = 'PLAYING'; 
                document.getElementById('pause-overlay').style.display = 'none'; 
                CLOCK.start(); animate(); 
            }
        };

        function updateHUD() {
            let day = Math.floor((monthTimer / SECONDS_PER_MONTH) * 30) + 1;
            if(day > 30) day = 30;
            document.getElementById('ui-calendar').innerText = `ğŸ“… ${currentMonth}æœˆ ${day}æ—¥`;
            document.getElementById('ui-score').innerText = `KPI: ${score}`;
            document.getElementById('ui-hearts').innerText = "â¤ï¸".repeat(health) + "ğŸ–¤".repeat(3-health);
            document.getElementById('ui-iso').innerText = `ISO: ${isoCount}/5`;
        }

        function createObs() {
            const rand = Math.random();
            let type = 'bug';
            if(rand<0.35) type='bug'; 
            else if(rand<0.6) type='computer'; 
            else if(rand<0.75) type='fish'; 
            else if(rand<0.85) type='tea';  
            else if(rand<0.92) type='iso'; 
            else type='quiz'; 

            let size = 1.8;
            if(type === 'bug') size = 2.2; 

            const mesh = new THREE.Mesh(new THREE.PlaneGeometry(size,size), mats[type]);
            mesh.position.set(lanes[Math.floor(Math.random()*3)], size/2, -80); 
            mesh.userData={type}; mesh.castShadow=true; scene.add(mesh); obstacles.push(mesh);
        }

        function showFloatingMsg(text, color) {
            const msg = document.getElementById('center-msg');
            msg.innerText = text; msg.style.color = color;
            msg.style.display = 'block'; msg.style.fontSize = "60px";
            setTimeout(() => { if(gameState=='PLAYING') msg.style.display = 'none'; }, 1000);
        }

        function triggerGameOver(success = false) {
            gameState='GAMEOVER'; playSound(success?'sfx-win':'sfx-hit');
            document.querySelector('#game-title').innerText = success ? "ğŸ‰ å¹´åº¦å…¨å‹¤å¥– ğŸ‰" : "è€ƒæ ¸å¤±è´¥"; 
            document.querySelector('.btn-start').innerText = "æ–°çš„ä¸€å¹´";
            document.getElementById('start-ui').style.display = 'none';
            document.getElementById('preview-jiji').style.display='block';
            document.getElementById('game-over-ui').style.display = 'flex';
            document.getElementById('final-score-display').innerText = score;
            
            let comment = "";
            if(success) comment = "æ­å–œä½ æ’‘è¿‡äº†å®Œæ•´çš„ä¸€å¹´ï¼<br>ä½ çš„èŒåœºç”Ÿå­˜èƒ½åŠ›å·²è¾¾æ»¡çº§ï¼";
            else comment = getComment(score);

            document.getElementById('final-comment-display').innerHTML = comment;
            document.getElementById('overlay').style.display='flex'; 
        }

        function getComment(s) {
            if(s < 200) return "ğŸ˜« è¿™ç‚¹ KPI...<br>å¹´ç»ˆå¥–æ³¡æ±¤äº†ï¼";
            if(s < 500) return "ğŸ˜ é©¬é©¬è™è™ã€‚<br>æ˜å¹´ç»§ç»­åŠªåŠ›ã€‚";
            if(s < 1000) return "ğŸ˜ å¹²å¾—æ¼‚äº®ï¼<br>ä½ æ˜¯éƒ¨é—¨çš„å¸Œæœ›ï¼";
            return "ğŸ‘‘ èŒåœºä¹‹ç¥ï¼<br>è¯·æ”¶ä¸‹è†ç›–ï¼";
        }

        function playSound(id) {
            const el = document.getElementById(id);
            if(id === 'bgm') el.volume = 0.5;
            el.currentTime = 0;
            el.play().catch(e => console.log("ç­‰å¾…äº¤äº’æ’­æ”¾å£°éŸ³"));
        }

        function animate() {
            if(gameState === 'COUNTDOWN') {
                if(jijiMesh) jijiMesh.position.y = 1 + Math.sin(Date.now() * 0.003) * 0.05; 
                renderer.render(scene, camera); requestAnimationFrame(animate); return;
            }

            if(gameState !== 'PLAYING') return;

            const delta = CLOCK.getDelta();
            monthTimer += delta;
            
            if(monthTimer >= SECONDS_PER_MONTH) { showSportClub(); return; }
            updateHUD();
            
            frame++; 
            if(frame % 600 === 0 && gameSpeed < 0.4) gameSpeed += 0.01;
            let spawnRate = Math.floor(25 / gameSpeed); 
            if(frame % spawnRate == 0) createObs();

            if(jijiMesh) {
                jijiMesh.position.x += (lanes[lane]-jijiMesh.position.x)*0.15;
                jijiMesh.position.y = 1 + Math.abs(Math.sin(frame*0.1))*0.1;
                jijiMesh.rotation.z = (jijiMesh.position.x - lanes[lane]) * -0.05;
            }
            
            for(let i=obstacles.length-1; i>=0; i--){
                const o = obstacles[i]; o.position.z += gameSpeed;
                if(Math.abs(o.position.z - jijiMesh.position.z)<0.8 && Math.abs(o.position.x - jijiMesh.position.x)<1.0){
                    const t=o.userData.type;
                    
                    if(t=='bug') { score+=10; playSound('sfx-coin'); }
                    else if(t=='tea') { 
                        playSound('sfx-coin');
                        if(health<3){health++;showFloatingMsg("å›è¡€!","pink");}else showFloatingMsg("æ»¡è¡€!","pink"); 
                    }
                    else if(t=='computer') { 
                        playSound('sfx-hit');
                        health--; showFloatingMsg("ğŸ’”", "red"); scene.background = new THREE.Color(0xff0000); setTimeout(()=>scene.background=new THREE.Color(0xdceefb),100);
                        if(health<=0) triggerGameOver(false);
                    }
                    else if(t=='fish') { score-=15; playSound('sfx-hit'); showFloatingMsg("æ‘¸é±¼ -15", "#00bfff"); }
                    else if(t=='iso') { isoCount++; playSound('sfx-coin'); showFloatingMsg(`${isoCount}/5`, "cyan"); if(isoCount>=5){score+=50;isoCount=0;showFloatingMsg("BONUS!", "gold");} }
                    else if(t=='quiz') { 
                        playSound('sfx-jump'); scene.remove(o); obstacles.splice(i,1); 
                        showQuiz(false); return;
                    }
                    scene.remove(o); obstacles.splice(i,1); updateHUD(); continue;
                }
                if(o.position.z>5) { scene.remove(o); obstacles.splice(i,1); }
            }
            grid.position.z += gameSpeed; if(grid.position.z>0) grid.position.z=-50;
            renderer.render(scene, camera); requestAnimationFrame(animate);
        }

        // --- ç­”é¢˜ ---
        function showQuiz(isSportClub) {
            gameState = 'QUIZ'; 
            const q = questions[Math.floor(Math.random()*questions.length)];
            const m = document.getElementById('quiz-modal'); 
            const title = document.getElementById('quiz-title');
            m.style.display='block';
            
            if(isSportClub) {
                title.innerText = `ğŸ‹ï¸â€â™‚ï¸ ${currentMonth}æœˆ Sport Club çªå‡»ï¼`;
                title.style.color = "#00b894"; m.style.border = "5px solid #00b894";
            } else {
                title.innerText = "ğŸ”¥ èŒåœºé€å‘½é¢˜";
                title.style.color = "#6c5ce7"; m.style.border = "5px solid #6c5ce7";
            }

            document.getElementById('quiz-question').innerText=q.q;
            const div = document.getElementById('quiz-options'); div.innerHTML='';
            
            q.o.forEach((opt,i)=>{
                const b=document.createElement('button'); b.className='quiz-btn'; b.innerText=opt;
                b.onclick=()=>{ 
                    m.style.display='none'; 
                    if(isSportClub) {
                        if(i==q.a) { score+=50; playSound('sfx-coin'); showFloatingMsg("Sport Club +50!", "green"); }
                        else { playSound('sfx-hit'); showFloatingMsg("Pass...", "gray"); }
                        currentMonth++; monthTimer = 0;
                        if(currentMonth > 12) triggerGameOver(true);
                        else setTimeout(() => { startCountdown(); }, 500);
                    } else {
                        if(i==q.a) { score+=50; playSound('sfx-coin'); showFloatingMsg("æ¼‚äº® +50!", "green"); } 
                        else { score-=50; playSound('sfx-hit'); showFloatingMsg("æƒ¨äº† -50!", "red"); } 
                        setTimeout(() => { startCountdown(); }, 500);
                    }
                    updateHUD(); 
                };
                div.appendChild(b);
            });
        }
        function showSportClub() { showQuiz(true); }

        // --- æ’è¡Œæ¦œ ---
        window.submitScore = async () => {
            const name = document.getElementById('player-name-inp').value.trim();
            if(!name) { alert("è¯·è¾“å…¥å¤§å!"); return; }
            if(!isFirebaseReady) { alert("Firebase æœªè¿æ¥!"); return; }
            const btn = document.querySelector('#game-over-ui .btn-start'); btn.innerText = "ä¸Šä¼ ä¸­...";
            try {
                await addDoc(collection(db, "leaderboard"), { name: name, score: score, date: new Date().toISOString() });
                alert("ä¸Šä¼ æˆåŠŸ!"); showRanking();
            } catch (e) { alert("ä¸Šä¼ å¤±è´¥: " + e.message); }
            btn.innerText = "ä¸Šä¼ æˆç»©";
        };

        window.showRanking = async () => {
            document.getElementById('ranking-modal').style.display = 'flex';
            const list = document.getElementById('ranking-list'); list.innerHTML = '<div style="color:#999; margin-top:50px;">åŠ è½½ä¸­...</div>';
            if(!isFirebaseReady) { list.innerHTML = "ç¦»çº¿æ¨¡å¼ (æœªé…ç½® Firebase)"; return; }
            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10));
                const snap = await getDocs(q);
                list.innerHTML = ""; let rank = 1;
                snap.forEach((doc) => {
                    const d = doc.data();
                    let medal = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : rank));
                    const row = document.createElement('div'); row.className = 'ranking-row';
                    row.innerHTML = `<span class="rank-num">${medal}</span> <span class="rank-name">${d.name}</span> <span class="rank-score">${d.score}</span>`;
                    list.appendChild(row); rank++;
                });
                if(rank === 1) list.innerHTML = "æš‚æ— æ•°æ®ï¼Œå¿«æ¥æŠ¢ç¬¬ä¸€ï¼";
            } catch (e) { list.innerHTML = "åŠ è½½å¤±è´¥"; }
        };

        window.addEventListener('keydown', e=>{ 
            if(e.key === 'p' || e.key === 'P') togglePause();
            if(gameState!='PLAYING') return;
            if((e.key=='ArrowLeft'||e.key=='a') && lane>0) { lane--; playSound('sfx-jump'); }
            if((e.key=='ArrowRight'||e.key=='d') && lane<2) { lane++; playSound('sfx-jump'); }
        });
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
